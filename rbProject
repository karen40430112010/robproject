import json
import os
import requests
from datetime import datetime

class Badge:
    def __init__(self, id, name, description=None, awarded_at=None):
        self.id = id
        self.name = name
        self.description = description
        self.awarded_at = awarded_at

class User:
    def __init__(self, username, id):
        self.id = id
        self.username = username

class BadgeBook:
    def __init__(self, user, badges):
        self.user = user
        self.badges = badges

    def total(self):
        return len(self.badges)

    def new_since(self, date):
        return [badge for badge in self.badges if badge.awarded_at and badge.awarded_at > date]

    def by_keyword(self, keyword):
        return [badge for badge in self.badges if keyword.lower() in badge.name.lower()]

    def save(self, filename):
        data = {
            'user': {'id': self.user.id, 'username': self.user.username},
            'badges': [
                {
                    'id': badge.id,
                    'name': badge.name,
                    'awarded_at': badge.awarded_at.isoformat() if badge.awarded_at else None
                } for badge in self.badges
            ]
        }
        with open(filename, 'w') as f:
            json.dump(data, f, indent=4)

def lookup_user_id(username):
    url = 'https://api.roblox.com/users/get-by-username'
    response = requests.post(url, json={'username': username, 'excludeBannedUser': True})
    if response.status_code == 200:
        data = response.json()
        if data.get('data'):
            return data['data'][0]['id']
        else:
            raise ValueError('User not found')
    else:
        raise Exception('Error fetching user')

def list_user_badges(user_id):
    badges = []
    url = f'https://api.roblox.com/users/{user_id}/badges'
    while url:
        response = requests.get(url)
        if response.status_code == 200:
            data = response.json()
            badges.extend(data['data'])
            cursor = data.get('nextPageCursor')
            url = f'https://api.roblox.com/users/{user_id}/badges?cursor={cursor}' if cursor else None
        else:
            raise Exception('Error fetching badges')
    return [{'badgeId': badge['id'], 'name': badge['name']} for badge in badges]

def get_awarded_dates(user_id, badge_ids):
    url = f'https://api.roblox.com/users/{user_id}/badges/awarded-dates'
    response = requests.get(url)
    if response.status_code == 200:
        return response.json().get('data', {})
    else:
        raise Exception('Error fetchin awarded dates')

def catch_response(url, data):
    cache_dir = 'cache'
    os.makedirs(cache_dir, exist_ok=True)
    cache_file = os.path.join(cache_dir, f'{hash(url)}.json')
    with open(cache_file, 'w') as f:
        json.dump(data, f)

def load_cache(url):
    cache_file = os.path.join('cache', f'{hash(url)}.json')
    if os.path.exists(cache_file):
        with open(cache_file) as f:
            return json.load(f)
    return None

def main():
    badge_book = None

    while True:
        print('\nMenu')
        print('1) Search user')
        print('2) Show total')
        print('3) Show recent')
        print('4) Filter by word')
        print('5) Snapshot')
        print('6) Diff snapshots')
        print('7) Exit')
        choice = input('Choose an option: ')

        if choice == '1':
            username = input('Enter Roblox username: ')
            try:
                user_id = lookup_user_id(username)
                user = User(username, user_id)
                badges_data = list_user_badges(user_id)
                badges = [Badge(badge['badgeId'], badge['name']) for badge in badges_data]
                badge_book = BadgeBook(user, badges)
                print(f'User ID: {user.id}, Total badges: {badge_book.total()}')
            except Exception as e:
                print(f'Error: {e}')

        elif choice == '2':
            if badge_book:
                print(f'Total badges: {badge_book.total()}')
            else:
                print('No user loaded.')

        elif choice == '3':
            if badge_book:
                date_str = input('Enter date (YYYY-MM-DD): ')
                try:
                    date = datetime.strptime(date_str, '%Y-%m-%d')
                    recent = badge_book.new_since(date)
                    for badge in recent:
                        print(f'{badge.name} awarded at {badge.awarded_at}')
                except ValueError:
                    print('Invalid date format.')
            else:
                print('No user loaded.')

        elif choice == '4':
            if badge_book:
                keyword = input('Enter keyword: ')
                filtered = badge_book.by_keyword(keyword)
                for badge in filtered:
                    print(f'{badge.name}')
            else:
                print('No user loaded.')

        elif choice == '5':
            if badge_book:
                filename = input('Enter filename to save snapshot: ')
                badge_book.save(filename)
                print(f'Snapshot saved to {filename}')
            else:
                print('No user loaded.')

        elif choice == '6':
            print('Snapshot diff not implemented yet.')

        elif choice == '7':
            break

if __name__ == '__main__':
    main()
